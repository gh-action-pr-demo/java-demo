name: Dependency Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [opened, synchronize, reopened]
  issues:
    types: [labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number from context
        id: get-pr-number
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.eventName === 'issues') {
              // Get PR number from issues.labeled/unlabeled event
              // Triggered only when adding or removing dependency-check-ignore label
              const labelName = context.payload.label?.name;
              const action = context.payload.action; // 'labeled' or 'unlabeled'
              
              console.log(`=== Label Event Triggered ===`);
              console.log(`Event Type: ${context.eventName}`);
              console.log(`Action: ${action}`);
              console.log(`Label Name: ${labelName}`);
              console.log(`Issue Number: ${context.payload.issue?.number}`);
              
              if (labelName !== 'dependency-check-ignore') {
                console.log(`Label ${labelName} is not dependency-check-ignore, skipping`);
                core.setOutput('is_pr', 'false');
                return;
              }
              
              prNumber = context.payload.issue.number;
              // Verify if it's a PR
              if (!context.payload.issue.pull_request) {
                console.log('This is not a PR, skipping');
                core.setOutput('is_pr', 'false');
                return;
              }
              
              if (action === 'labeled') {
                console.log(`Detected addition of dependency-check-ignore label, triggering dependency check`);
              } else if (action === 'unlabeled') {
                console.log(`Detected removal of dependency-check-ignore label, triggering dependency check`);
              }
            } else {
              // Get PR number from pull_request event
              prNumber = context.payload.pull_request.number;
            }
            
            core.setOutput('pr_number', prNumber.toString());
            core.setOutput('is_pr', 'true');
            console.log(`PR Number: ${prNumber}, Event: ${context.eventName}`);

      - name: Checkout repository
        if: steps.get-pr-number.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if dependency check is ignored
        id: check-ignored
        if: steps.get-pr-number.outputs.is_pr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber)
            });
            
            const labels = issue.labels.map(l => l.name);
            const isIgnored = labels.includes('dependency-check-ignore');
            
            console.log(`PR Labels: ${labels.join(', ')}`);
            console.log(`Check Ignored: ${isIgnored}`);
            
            core.setOutput('ignored', isIgnored.toString());
            
            if (isIgnored) {
              console.log('Dependency check has been ignored, skipping check');
            }

      - name: Skip if ignored and post comment
        if: steps.check-ignored.outputs.ignored == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Create comment explaining check was skipped due to label
            let skipComment = `## ğŸ”’ Dependency Review\n\n`;
            skipComment += `â­ï¸ **Dependency Check Skipped**\n\n`;
            skipComment += `**Reason**: PR has been tagged with \`dependency-check-ignore\` label\n\n`;
            skipComment += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
            skipComment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š View Actions Run Details</a>\n\n`;
            skipComment += `**Tip**: To re-enable the check, please remove the \`dependency-check-ignore\` label.\n\n`;
            skipComment += `---\n`;
            skipComment += `*This comment was automatically generated by GitHub Actions*\n`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body: skipComment
              });
              console.log('Created "check skipped" comment');
            } catch (error) {
              console.error('Failed to create comment:', error);
            }
            
            // Create a successful check run to override previous failure status
            try {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'Dependency Review',
                head_sha: pr.head.sha,
                status: 'completed',
                conclusion: 'success',
                output: {
                  title: 'Dependency Check Skipped',
                  summary: 'This PR has been tagged with `dependency-check-ignore` label, dependency check has been skipped.'
                }
              });
              console.log('Created successful check run');
            } catch (checkError) {
              console.error('Failed to create check run:', checkError);
            }
            
            // Exit successfully
            process.exit(0);

      - name: Read policy configuration
        id: policy-config
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to read config from GitHub first (for centralized config)
          # If fails, fall back to local config
          
          CONFIG_SOURCE=""
          CONFIG_FILE_PATH=""
          
          # Try GitHub config first
          GITHUB_CONFIG_REPO="${GITHUB_CONFIG_REPO:-gh-action-pr-demo/config}"
          GITHUB_CONFIG_REF="${GITHUB_CONFIG_REF:-main}"
          GITHUB_CONFIG_PATH=".github/policies/config.txt"
          GITHUB_CONFIG_URL="https://raw.githubusercontent.com/$GITHUB_CONFIG_REPO/$GITHUB_CONFIG_REF/$GITHUB_CONFIG_PATH"
          
          echo "Attempting to read config from GitHub: $GITHUB_CONFIG_URL"
          if curl -f -s -H "Authorization: token $GITHUB_TOKEN" "$GITHUB_CONFIG_URL" > /tmp/policy-config.txt 2>/dev/null; then
            CONFIG_SOURCE="github"
            CONFIG_FILE_PATH="/tmp/policy-config.txt"
            echo "âœ“ Config loaded from GitHub: $GITHUB_CONFIG_REPO"
          elif [ -f ".github/policies/config.txt" ]; then
            CONFIG_SOURCE="local"
            CONFIG_FILE_PATH=".github/policies/config.txt"
            echo "âœ“ Config loaded from LOCAL: $CONFIG_FILE_PATH"
          else
            echo "âš  No config file found, using defaults"
            CONFIG_SOURCE="default"
          fi
          
          # Parse configuration
          if [ "$CONFIG_SOURCE" != "default" ]; then
            echo "Configuration file content:"
            cat "$CONFIG_FILE_PATH"
            echo ""
            
            # Parse policy_source
            POLICY_SOURCE=$(grep "^policy_source:" "$CONFIG_FILE_PATH" | cut -d':' -f2 | tr -d ' ' || echo "local")
            
            # Parse GitHub policy repo settings (used if policy_source=github)
            POLICY_REPO=$(grep "^policy_repo:" "$CONFIG_FILE_PATH" | cut -d':' -f2 | tr -d ' ' || echo "")
            POLICY_REF=$(grep "^policy_ref:" "$CONFIG_FILE_PATH" | cut -d':' -f2 | tr -d ' ' || echo "main")
            POLICY_PATH=$(grep "^policy_path:" "$CONFIG_FILE_PATH" | cut -d':' -f2 | tr -d ' ' || echo ".github/policies")
            
            # Parse severity settings
            FAIL_ON_SEVERITY=$(grep "^fail_on_severity:" "$CONFIG_FILE_PATH" | cut -d':' -f2 | tr -d ' ' || echo "high")
            MIN_SEVERITY=$(grep "^min_severity:" "$CONFIG_FILE_PATH" | cut -d':' -f2 | tr -d ' ' || echo "critical")
          else
            # Defaults
            POLICY_SOURCE="local"
            POLICY_REPO=""
            POLICY_REF="main"
            POLICY_PATH=".github/policies"
            FAIL_ON_SEVERITY="high"
            MIN_SEVERITY="critical"
          fi
          
          # Set outputs
          echo "policy_source=$POLICY_SOURCE" >> $GITHUB_OUTPUT
          echo "policy_repo=$POLICY_REPO" >> $GITHUB_OUTPUT
          echo "policy_ref=$POLICY_REF" >> $GITHUB_OUTPUT
          echo "policy_path=$POLICY_PATH" >> $GITHUB_OUTPUT
          echo "fail_on_severity=$FAIL_ON_SEVERITY" >> $GITHUB_OUTPUT
          echo "min_severity=$MIN_SEVERITY" >> $GITHUB_OUTPUT
          
          echo ""
          echo "=== Configuration Summary ==="
          echo "Policy Source: $POLICY_SOURCE"
          if [ "$POLICY_SOURCE" = "github" ]; then
            echo "Policy Repo: $POLICY_REPO"
            echo "Policy Ref: $POLICY_REF"
            echo "Policy Path: $POLICY_PATH"
          fi
          echo "Fail on Severity: $FAIL_ON_SEVERITY"
          echo "Min Severity: $MIN_SEVERITY"
          echo "============================"

      # Auto-detect and submit Gradle dependencies
      - name: Detect Gradle project and JDK version
        id: detect-gradle
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        run: |
          # Check for Gradle build files (supports multi-module projects)
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] || find . -type f \( -name "build.gradle" -o -name "build.gradle.kts" \) | grep -q .; then
            echo "is_gradle=true" >> $GITHUB_OUTPUT
            echo "âœ“ Gradle project detected"
            
            # Auto-detect Java version from gradle.properties or use default
            JAVA_VERSION="17"  # Default to LTS
            
            if [ -f "gradle.properties" ]; then
              # Try to extract Java version from gradle.properties
              DETECTED_VERSION=$(grep -E "^(java\.?)?target(Compatibility)?|sourceCompatibility" gradle.properties | head -1 | grep -oE '[0-9]+' || echo "")
              if [ -n "$DETECTED_VERSION" ]; then
                JAVA_VERSION="$DETECTED_VERSION"
                echo "â„¹ Detected Java version from gradle.properties: $JAVA_VERSION"
              fi
            fi
            
            # Try to detect from build.gradle
            if [ -f "build.gradle" ] && [ "$JAVA_VERSION" = "17" ]; then
              DETECTED_VERSION=$(grep -E "sourceCompatibility|targetCompatibility" build.gradle | head -1 | grep -oE '[0-9]+' || echo "")
              if [ -n "$DETECTED_VERSION" ]; then
                JAVA_VERSION="$DETECTED_VERSION"
                echo "â„¹ Detected Java version from build.gradle: $JAVA_VERSION"
              fi
            fi
            
            # Validate Java version (must be >= 8)
            if [ "$JAVA_VERSION" -lt 8 ]; then
              echo "âš  Java version $JAVA_VERSION is too old, using 17 instead"
              JAVA_VERSION="17"
            fi
            
            echo "java_version=$JAVA_VERSION" >> $GITHUB_OUTPUT
            echo "âœ“ Will use Java $JAVA_VERSION for Gradle build"
            
            # Detect all Gradle modules for better reporting
            MODULE_COUNT=$(find . -type f \( -name "build.gradle" -o -name "build.gradle.kts" \) | wc -l | tr -d ' ')
            echo "â„¹ Found $MODULE_COUNT Gradle module(s)"
          else
            echo "is_gradle=false" >> $GITHUB_OUTPUT
            echo "â„¹ No Gradle project detected"
          fi

      - name: Set up JDK for Gradle
        if: steps.detect-gradle.outputs.is_gradle == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ steps.detect-gradle.outputs.java_version }}

      - name: Setup Gradle
        if: steps.detect-gradle.outputs.is_gradle == 'true'
        uses: gradle/actions/setup-gradle@v3

      - name: Submit Gradle dependency graph
        if: steps.detect-gradle.outputs.is_gradle == 'true'
        uses: gradle/actions/dependency-submission@v3
        with:
          # This action automatically handles multi-module projects
          # It will discover all build.gradle files recursively
          dependency-graph: generate-and-submit

      - name: Dependency Review
        id: dep-review
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        continue-on-error: true
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: ${{ steps.policy-config.outputs.fail_on_severity }}
          comment-summary-in-pr: never  # Disable default comment, use custom filter

      # Write vulnerable-changes to file (avoid shell parsing issues)
      - name: Write vulnerable changes to file
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        run: |
          cat > /tmp/vulnerable-changes.json << 'VULNERABILITY_EOF'
          ${{ steps.dep-review.outputs.vulnerable-changes }}
          VULNERABILITY_EOF

      - name: Filter vulnerabilities by policy
        id: filter-vulns
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        run: |
          set +e  # Don't exit on error
          echo "=== Filtering vulnerabilities by policy ==="
          
          # Validate JSON and get count
          VULN_COUNT=$(jq '. | length' /tmp/vulnerable-changes.json 2>/dev/null || echo "0")
          
          if [ "$VULN_COUNT" = "0" ] || [ "$VULN_COUNT" = "null" ]; then
            echo "No vulnerabilities detected or invalid JSON"
            echo '{\"filtered_vulnerabilities\":[],\"metrics\":{},\"summary\":{\"total_vulnerabilities\":0,\"policy_violations\":0,\"min_severity\":\"critical\"}}' > /tmp/filter-output.json
            echo "has_violations=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Input vulnerabilities count: $VULN_COUNT"
          
          # Set environment variables for filter script from policy configuration
          export VULNERABLE_CHANGES=$(cat /tmp/vulnerable-changes.json)
          export POLICY_SOURCE=${{ steps.policy-config.outputs.policy_source }}
          export MIN_SEVERITY=${{ steps.policy-config.outputs.min_severity }}
          
          # Additional env vars for GitHub policy source
          if [ "$POLICY_SOURCE" = "github" ]; then
            export POLICY_REPO=${{ steps.policy-config.outputs.policy_repo }}
            export POLICY_REF=${{ steps.policy-config.outputs.policy_ref }}
            export POLICY_PATH=${{ steps.policy-config.outputs.policy_path }}
            export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
            
            echo "Using policy source: github"
            echo "  Policy repository: $POLICY_REPO"
            echo "  Policy ref: $POLICY_REF"
            echo "  Policy path: $POLICY_PATH"
          else
            echo "Using policy source: local"
            echo "  Policy path: .github/policies/"
          fi
          
          echo "Min severity: $MIN_SEVERITY"
          
          # Run filter script (stdout=JSON to file, stderr=logs to console)
          # Note: Do NOT use 2>&1 here - we want stderr (logs) to go to console, not to file
          node .github/scripts/filter-vulnerabilities.js > /tmp/filter-output.json
          FILTER_EXIT_CODE=$?
          
          echo "Filter exit code: $FILTER_EXIT_CODE"
          echo "Filter script JSON output - first 20 lines:"
          head -20 /tmp/filter-output.json 2>/dev/null || echo "No output file"
          
          # Check if filter output is empty
          if [ ! -s /tmp/filter-output.json ]; then
            echo "Error: filter output file not created"
            echo '{"filtered_vulnerabilities":[],"metrics":{},"summary":{"total_vulnerabilities":0,"policy_violations":0,"min_severity":"critical"}}' > /tmp/filter-output.json
            echo "has_violations=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Validate JSON
          if ! jq empty /tmp/filter-output.json 2>/dev/null; then
            echo "Error: filter output is not valid JSON"
            echo "Raw output:"
            cat /tmp/filter-output.json
            echo '{"filtered_vulnerabilities":[],"metrics":{},"summary":{"total_vulnerabilities":0,"policy_violations":0,"min_severity":"critical"}}' > /tmp/filter-output.json
            echo "has_violations=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Set outputs based on exit code
          if [ $FILTER_EXIT_CODE -eq 1 ]; then
            echo "has_violations=true" >> $GITHUB_OUTPUT
            echo "Set has_violations=true"
          else
            echo "has_violations=false" >> $GITHUB_OUTPUT
            echo "Set has_violations=false"
          fi
          
          exit 0  # Always succeed

      # Debug steps - commented out to reduce noise, uncomment if needed for troubleshooting
      # - name: Debug - Check dependencies
      #   if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
      #   run: |
      #     echo "=== Check pom.xml Files ==="
      #     find . -name "pom.xml" -type f
      #     echo ""
      #     echo "=== module-service/pom.xml Contents ==="
      #     cat module-service/pom.xml 2>/dev/null || echo "File not found"
      #     echo ""
      #     echo "=== Check log4j Dependency ==="
      #     grep -r "log4j" --include="*.xml" . || echo "log4j not found"
      #     echo ""
      #     echo "=== Dependency Review Output Status ==="
      #     echo "Outcome: ${{ steps.dep-review.outcome }}"
      #     echo "Exit code: ${{ steps.dep-review.exit-code }}"
      #     echo ""
      #     echo "=== Dependency Review vulnerable-changes Output ==="
      #     echo "Length: $(echo '${{ steps.dep-review.outputs.vulnerable-changes }}' | wc -c)"
      #     echo "Content preview (first 500 chars):"
      #     echo '${{ steps.dep-review.outputs.vulnerable-changes }}' | head -c 500
      #     echo ""
      #     echo "Parsed with jq:"
      #     echo '${{ steps.dep-review.outputs.vulnerable-changes }}' | jq '.' 2>&1 | head -50 || echo "Failed to parse JSON"
      #     echo ""
      #     echo "=== Filter Output Status ==="
      #     echo "Has violations: ${{ steps.filter-vulns.outputs.has_violations }}"
      #     if [ -f /tmp/filter-output.json ]; then
      #       echo "Filter output:"
      #       cat /tmp/filter-output.json | jq '.summary'
      #       echo ""
      #       echo "Filter output (full):"
      #       cat /tmp/filter-output.json | jq '.'
      #     fi
      #
      # - name: Debug - PR comment conditions
      #   if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
      #   run: |
      #     echo "=== PR Comment Conditions Debug ==="
      #     echo "is_pr: ${{ steps.get-pr-number.outputs.is_pr }}"
      #     echo "ignored: ${{ steps.check-ignored.outputs.ignored }}"
      #     echo "has_violations: ${{ steps.filter-vulns.outputs.has_violations }}"
      #     echo "filter-vulns outcome: ${{ steps.filter-vulns.outcome }}"
      #     echo "filter-vulns conclusion: ${{ steps.filter-vulns.conclusion }}"
      #     echo ""
      #     echo "Will post violation comment: ${{ steps.filter-vulns.outputs.has_violations == 'true' }}"
      #     echo "Will post no violation comment: ${{ steps.filter-vulns.outputs.has_violations == 'false' || steps.filter-vulns.outputs.has_violations == '' }}"

      # WEBHOOK_HOOK: Notification when vulnerabilities are detected
      - name: Webhook - Vulnerabilities Detected
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true' && steps.filter-vulns.outputs.has_violations == 'true'
        run: |
          echo "=== WEBHOOK: Vulnerabilities Detected ==="
          echo "PR Number: ${{ steps.get-pr-number.outputs.pr_number }}"
          echo "Violations Count: $(cat /tmp/filter-output.json | jq '.summary.policy_violations')"
          echo "Min Severity: ${{ steps.policy-config.outputs.min_severity }}"
          # TODO: Replace with actual webhook call
          # curl -X POST "$WEBHOOK_URL" \
          #   -H "Content-Type: application/json" \
          #   -d '{
          #     "event": "vulnerabilities_detected",
          #     "pr_number": "${{ steps.get-pr-number.outputs.pr_number }}",
          #     "violations": $(cat /tmp/filter-output.json | jq '.summary.policy_violations'),
          #     "severity": "${{ steps.policy-config.outputs.min_severity }}"
          #   }'

      # WEBHOOK_HOOK: Notification when no vulnerabilities are detected
      - name: Webhook - No Vulnerabilities
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true' && (steps.filter-vulns.outputs.has_violations == 'false' || steps.filter-vulns.outputs.has_violations == '')
        run: |
          echo "=== WEBHOOK: No Vulnerabilities ==="
          echo "PR Number: ${{ steps.get-pr-number.outputs.pr_number }}"
          echo "Status: PASSED"
          echo "Min Severity: ${{ steps.policy-config.outputs.min_severity }}"
          # TODO: Replace with actual webhook call
          # curl -X POST "$WEBHOOK_URL" \
          #   -H "Content-Type: application/json" \
          #   -d '{
          #     "event": "no_vulnerabilities",
          #     "pr_number": "${{ steps.get-pr-number.outputs.pr_number }}",
          #     "status": "PASSED",
          #     "severity": "${{ steps.policy-config.outputs.min_severity }}"
          #   }'

      - name: Post filtered vulnerability comment
        id: post-filtered-comment
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true' && steps.filter-vulns.outputs.has_violations == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            
            // Read filtered output
            let filterOutput;
            try {
              const filterData = fs.readFileSync('/tmp/filter-output.json', 'utf-8');
              filterOutput = JSON.parse(filterData);
            } catch (error) {
              console.error('Failed to read filter output:', error);
              return;
            }
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            // Build comment
            const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            let comment = `## ğŸ”’ Dependency Security Check (Policy Filtered)\n\n`;
            comment += `âš ï¸ **Detected ${filterOutput.summary.min_severity} level vulnerabilities in policy-required packages**\n\n`;
            comment += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
            comment += `**Statistics**:\n`;
            comment += `- Total Vulnerabilities: ${filterOutput.summary.total_vulnerabilities}\n`;
            comment += `- Policy Violations: ${filterOutput.summary.policy_violations}\n`;
            comment += `- Minimum Severity: ${filterOutput.summary.min_severity}\n`;
            comment += `- Build Failure Threshold: ${{ steps.policy-config.outputs.fail_on_severity }}\n\n`;
            
            comment += `### ğŸ“‹ Policy Violation Details\n\n`;
            
            // Single merged table
            comment += `| Package Name | Ecosystem | Current Version | Vulnerabilities | Vulnerability List |\n`;
            comment += `|--------------|-----------|-----------------|-----------------|-------------------|\n`;
            
            // Table rows
            for (const vuln of filterOutput.filtered_vulnerabilities) {
              const metrics = filterOutput.metrics[vuln.name];
              
              // Build vulnerability list for this package
              let vulnList = '';
              if (vuln.vulnerabilities && vuln.vulnerabilities.length > 0) {
                vulnList = vuln.vulnerabilities.map(v => {
                  const emoji = v.severity === 'critical' ? 'ğŸ”´' : 
                               v.severity === 'high' ? 'ğŸŸ ' : 
                               v.severity === 'moderate' ? 'ğŸŸ¡' : 'âšª';
                  const id = v.advisory_ghsa_id || v.advisory_cve_id || 'N/A';
                  return `${emoji} ${v.severity} ${id}`;
                }).join('<br>');
              }
              
              comment += `| \`${vuln.name}\` | ${vuln.ecosystem} | \`${vuln.version}\` | ${metrics.vulnerability_count} | ${vulnList} |\n`;
            }
            
            comment += `\n`;
            
            comment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š View Complete Dependency Security Check Report</a>\n\n`;
            comment += `**Tip**: These packages are flagged in the upstream policy for attention. To ignore this check, add the \`dependency-check-ignore\` label to the PR.\n\n`;
            comment += `---\n`;
            comment += `*This comment was automatically generated by GitHub Actions (Policy Filtered Version)*\n`;
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: comment
            });
            
            console.log('Created policy-filtered vulnerability comment');

      - name: Post no violations comment
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true' && (steps.filter-vulns.outputs.has_violations == 'false' || steps.filter-vulns.outputs.has_violations == '')
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            let comment = `## ğŸ”’ Dependency Security Check (Policy Filtered)\n\n`;
            comment += `âœ… **No ${{ steps.policy-config.outputs.min_severity }} level vulnerabilities detected in policy-required packages**\n\n`;
            comment += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
            comment += `**Configuration**: Minimum Severity = ${{ steps.policy-config.outputs.min_severity }}, Build Failure Threshold = ${{ steps.policy-config.outputs.fail_on_severity }}\n\n`;
            comment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š View Complete Dependency Security Check Report</a>\n\n`;
            comment += `---\n`;
            comment += `*This comment was automatically generated by GitHub Actions (Policy Filtered Version)*\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber),
              body: comment
            });
            
            console.log('Created "no policy violations detected" comment');

      - name: Fail if vulnerabilities found
        if: steps.dep-review.outcome == 'failure'
        run: |
          echo "Security vulnerabilities found, please check the detailed report in PR comments"
          exit 1
